# ... parameters unchanged ...

steps:
  - task: TerraformInstaller@1
    displayName: 'Install Terraform latest'
    inputs:
      terraformVersion: latest

  - task: TerraformTaskV4@4
    displayName: 'Terraform Init'
    inputs:
      provider: 'azurerm'
      command: 'init'
      workingDirectory: '${{ parameters.workingDirectory }}'
      backendServiceArm: '$(azureServiceConnection)'
      backendAzureRmResourceGroupName: 'pokedata-terraform-state-rg'
      backendAzureRmStorageAccountName: 'tfstateyul4ts'
      backendAzureRmContainerName: 'tfstate'
      backendAzureRmKey: 'pokedata/${{ parameters.environment }}.tfstate'
    env:
      TF_VAR_github_token: $(github_token)   # secret var from ADO group/Key Vault

  - task: TerraformTaskV4@4
    displayName: 'Terraform Plan'
    inputs:
      provider: 'azurerm'
      command: 'plan'
      workingDirectory: '${{ parameters.workingDirectory }}'
      # Explicit var-file; detailed-exitcode = 0 (no change) or 2 (changes)
      commandOptions: '-var-file=terraform.tfvars -out=tfplan -input=false -detailed-exitcode'
      environmentServiceNameAzureRM: '$(azureServiceConnection)'
      publishPlanResults: 'tfplan-${{ parameters.environment }}'
    env:
      TF_VAR_github_token: $(github_token)
    # Let exit code 2 (changes) pass; the task reports nonzero -> don't fail the job
    continueOnError: true

  - script: |
      # Normalize plan exit code: treat 2 (changes) as success-with-changes
      if [ "$(tail -n1 $(Agent.TempDirectory)/terraform_exit_code 2>/dev/null)" = "2" ]; then
        echo "Terraform reported changes (exit code 2). Proceeding."
      fi

      terraform show -no-color tfplan > tfplan.txt
      terraform show -json tfplan > tfplan.json

      echo "## Terraform Plan Summary for ${{ parameters.environment }}" > plan-summary.md
      echo "" >> plan-summary.md
      echo "**Environment:** ${{ parameters.environment }}" >> plan-summary.md
      echo "**Build:** $(Build.BuildNumber)" >> plan-summary.md
      echo "**Triggered by:** $(Build.RequestedFor)" >> plan-summary.md
      echo "" >> plan-summary.md
      echo "### Resource Changes:" >> plan-summary.md
      terraform show tfplan | grep -E "will be|must be" | head -20 >> plan-summary.md || true

      cat plan-summary.md
    displayName: 'Generate Plan Summary'
    workingDirectory: '${{ parameters.workingDirectory }}'
    env:
      TF_VAR_github_token: $(github_token)

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Terraform Plan'
    inputs:
      pathToPublish: '${{ parameters.workingDirectory }}/tfplan'
      artifactName: '${{ parameters.artifactName }}'
      publishLocation: 'Container'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Plan Output'
    inputs:
      pathToPublish: '${{ parameters.workingDirectory }}/tfplan.txt'
      artifactName: 'plan-output-${{ parameters.environment }}'
      publishLocation: 'Container'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Plan JSON'
    inputs:
      pathToPublish: '${{ parameters.workingDirectory }}/tfplan.json'
      artifactName: 'plan-json-${{ parameters.environment }}'
      publishLocation: 'Container'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Plan Summary'
    inputs:
      pathToPublish: '${{ parameters.workingDirectory }}/plan-summary.md'
      artifactName: 'plan-summary-${{ parameters.environment }}'
      publishLocation: 'Container'

  - task: GitHubComment@0
    displayName: 'Post Plan to PR'
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
    inputs:
      gitHubConnection: '$(githubServiceConnection)'
      repositoryName: '$(Build.Repository.Name)'
      comment: |
        ## Terraform Plan Results - ${{ parameters.environment }}
        Build: $(Build.BuildNumber)
        The Terraform plan has been generated and saved.
        [View Artifacts]($(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=artifacts)
    continueOnError: true

  - script: |
      echo "âœ… Terraform plan completed"
    displayName: 'Plan Complete'
