# Template for Terraform validation
parameters:
  - name: workingDirectory
    type: string
  - name: terraformVersion
    type: string

steps:
  - task: TerraformInstaller@0
    displayName: 'Install Terraform ${{ parameters.terraformVersion }}'
    inputs:
      terraformVersion: '${{ parameters.terraformVersion }}'

  # Style/format check
  - script: |
      terraform fmt -check -recursive
    displayName: 'Terraform fmt (check)'
    workingDirectory: '${{ parameters.workingDirectory }}'

  # Safe init for validation only (no backend access)
  - script: |
      terraform init -backend=false -input=false -upgrade
    displayName: 'Terraform init (no backend)'
    workingDirectory: '${{ parameters.workingDirectory }}'
    env:
      TF_VAR_github_token: $(github_token)

  # Validate configuration
  - script: |
      terraform validate -no-color
    displayName: 'Terraform validate'
    workingDirectory: '${{ parameters.workingDirectory }}'

  - script: |
      echo "##vso[task.setvariable variable=validation_complete]true"
      echo "âœ… Terraform validation completed successfully"
    displayName: 'Set Validation Status'
