# Azure DevOps CI/CD Pipeline for PokeData Infrastructure
# This pipeline demonstrates enterprise-grade DevOps practices for Terraform deployments

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - IaC_Projects/Terraform/PokeData/**
    exclude:
      - IaC_Projects/Terraform/PokeData/memory-bank/**
      - IaC_Projects/Terraform/PokeData/**/*.md

pr:
  branches:
    include:
      - main
  paths:
    include:
      - IaC_Projects/Terraform/PokeData/**
    exclude:
      - IaC_Projects/Terraform/PokeData/memory-bank/**
      - IaC_Projects/Terraform/PokeData/**/*.md

variables:
  - group: terraform-common
  - group: terraform-dev
  - name: terraformVersion
    value: '1.9.0'
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)/IaC_Projects/Terraform/PokeData/environments/dev'
  - name: artifactName
    value: 'terraform-plan'
  - name: environment
    value: 'dev'
  - name: azureServiceConnection
    value: 'ARM Service Connection - Thunderdome'
  - name: githubServiceConnection
    value: 'PokeData Repo Service Connection'

pool:
  name: Default
  # vmImage: 'ubuntu-latest'

stages:
  # Stage 1: Validation and Security Scanning
  - stage: Validate
    displayName: 'Validate & Scan'
    jobs:
      - job: ValidateTerraform
        displayName: 'Validate Terraform Configuration'
        steps:
          - template: templates/jobs/terraform-validate.yml
            parameters:
              workingDirectory: $(workingDirectory)
              terraformVersion: $(terraformVersion)

      - job: SecurityScan
        displayName: 'Security Scanning'
        dependsOn: ValidateTerraform
        steps:
          - template: templates/jobs/security-scan.yml
            parameters:
              workingDirectory: $(workingDirectory)

  # Stage 2: Plan
  - stage: Plan
    displayName: 'Terraform Plan'
    dependsOn: Validate
    condition: succeeded()
    jobs:
      - job: TerraformPlan
        displayName: 'Generate Terraform Plan'
        steps:
          - template: templates/jobs/terraform-plan.yml
            parameters:
              workingDirectory: $(workingDirectory)
              terraformVersion: $(terraformVersion)
              environment: $(environment)
              artifactName: $(artifactName)

  # Stage 3: Deploy (Only on main branch)
  - stage: Deploy
    displayName: 'Deploy to Dev'
    dependsOn: Plan
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployDev
        displayName: 'Deploy Infrastructure to Dev'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/jobs/terraform-apply.yml
                  parameters:
                    workingDirectory: $(workingDirectory)
                    terraformVersion: $(terraformVersion)
                    environment: $(environment)
                    artifactName: $(artifactName)

  # Stage 4: Post-Deployment Tests
  - stage: Test
    displayName: 'Post-Deployment Tests'
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: InfrastructureTests
        displayName: 'Run Infrastructure Tests'
        steps:
          - template: templates/jobs/infrastructure-tests.yml
            parameters:
              environment: $(environment)

  - stage: Notify
    displayName: Send Notifications
    condition: always()
    jobs:
    - job: SendZohoMail
      displayName: Send status via Zoho SMTP
      steps:
      - task: PowerShell@2
        displayName: 'Send Pipeline Status Email (Zoho)'
        inputs:
          targetType: 'inline'
          pwsh: true
          script: |
            $fromAddr = 'devops@maber.io'
            $fromName = 'PokeData CI'
            $to       = 'mike@maber.io'

            $smtpHost = 'smtp.zoho.com'    # change to smtp.zoho.eu if needed
            $smtpUser = 'devops@maber.io'
            $smtpPass = $env:ZOHO_SMTP_PASSWORD
            if ([string]::IsNullOrWhiteSpace($smtpPass)) { throw 'ZOHO_SMTP_PASSWORD is empty/unavailable' }

            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12

            $lines = @(
              "<b>Pipeline Status:</b> $(Agent.JobStatus)<br/>"
              "<b>Environment:</b> $(environment)<br/>"
              "<b>Build Number:</b> $(Build.BuildNumber)<br/>"
              "<b>Commit:</b> $(Build.SourceVersion)<br/>"
              "<b>Triggered By:</b> $(Build.RequestedFor)<br/>"
              "<br/>"
              "<a href='$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)'>View Pipeline</a>"
            )
            $body = ($lines -join "`n")

            $msg = [System.Net.Mail.MailMessage]::new()
            $msg.From = [System.Net.Mail.MailAddress]::new($fromAddr, $fromName)
            $msg.To.Add($to)
            $msg.Subject = "PokeData Pipeline - $(environment) - $(Build.SourceBranchName) - $(Agent.JobStatus)"
            $msg.Body = $body
            $msg.IsBodyHtml = $true

            $client = [System.Net.Mail.SmtpClient]::new($smtpHost, 587)  # STARTTLS
            $client.DeliveryMethod = [System.Net.Mail.SmtpDeliveryMethod]::Network
            $client.UseDefaultCredentials = $false
            $client.EnableSsl = $true
            $client.Credentials = [System.Net.NetworkCredential]::new($smtpUser, $smtpPass)

            $client.Send($msg)
            Write-Host ("Mail sent via {0}:{1}" -f $smtpHost, 587)

            $client.Dispose()
            $msg.Dispose()
        env:
          ZOHO_SMTP_PASSWORD: $(smtpPass)   # your Library/variable name
